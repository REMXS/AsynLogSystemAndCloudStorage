# AsynLogSystem & CloudStorage

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº C++20 å¼€å‘çš„é«˜æ€§èƒ½**å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ**ï¼Œå¹¶åŸºäºè¯¥æ—¥å¿—ç³»ç»Ÿå®ç°äº†ä¸€ä¸ª**è½»é‡çº§äº‘å­˜å‚¨æœåŠ¡å™¨**ã€‚

æœ¬æ–‡æ¡£ä¸»è¦ä»‹ç»æ ¸å¿ƒç»„ä»¶â€”â€”**å¼‚æ­¥æ—¥å¿—ç³»ç»Ÿ (AsynLogSystem)** çš„è®¾è®¡ä¸ä½¿ç”¨ã€‚

---

## ğŸ“ é¡¹ç›®ç®€ä»‹

**AsynLogSystem** æ—¨åœ¨æä¾›ä¸€ä¸ªä½å»¶è¿Ÿã€é«˜ååé‡çš„æ—¥å¿—è®°å½•æ–¹æ¡ˆã€‚å®ƒé‡‡ç”¨**å¤šç”Ÿäº§è€…-å•æ¶ˆè´¹è€…**æ¨¡å‹ï¼Œåˆ©ç”¨**åŒç¼“å†²åŒº (Double Buffering)** æŠ€æœ¯å°†å‰ç«¯ï¼ˆä¸šåŠ¡çº¿ç¨‹ï¼‰çš„æ—¥å¿—å†™å…¥ä¸åç«¯ï¼ˆè½ç›˜çº¿ç¨‹ï¼‰çš„ç£ç›˜ IO åˆ†ç¦»ï¼Œæå¤§åœ°é™ä½äº†æ—¥å¿—è®°å½•å¯¹ä¸šåŠ¡çº¿ç¨‹çš„é˜»å¡ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

* **é«˜æ€§èƒ½å¼‚æ­¥å†™å…¥**ï¼šé‡‡ç”¨åå°çº¿ç¨‹è´Ÿè´£ç£ç›˜ IOï¼Œä¸šåŠ¡çº¿ç¨‹ä»…éœ€å°†æ—¥å¿—å†™å…¥å†…å­˜ç¼“å†²åŒºï¼Œå®ç°çº³ç§’çº§å†™å…¥å»¶è¿Ÿã€‚
* **åŒç¼“å†²åŒºæœºåˆ¶**ï¼šä½¿ç”¨ç”Ÿäº§ç¼“å†²åŒºå’Œæ¶ˆè´¹ç¼“å†²åŒºäº¤æ›¿å·¥ä½œï¼Œå‡å°‘é”çš„ç«äº‰ï¼Œé¿å…å†…å­˜é¢‘ç¹åˆ†é…ä¸é‡Šæ”¾ã€‚
* **å¤šç§è½åœ°æ–¹å‘ (Sink)**ï¼š
* `StdOutFlush`: æ ‡å‡†è¾“å‡ºã€‚
* `FileFlush`: æŒ‡å®šæ–‡ä»¶è¾“å‡ºã€‚
* `RollFileFlush`: æ”¯æŒæŒ‰æ–‡ä»¶å¤§å°è‡ªåŠ¨æ»šåŠ¨ï¼ˆåˆ‡åˆ†ï¼‰æ—¥å¿—æ–‡ä»¶ã€‚


* **çµæ´»çš„ç¼“å†²ç­–ç•¥**ï¼š
* æ”¯æŒé™åˆ¶ç¼“å†²åŒºå¤§å°ï¼ˆä¸¢å¼ƒç­–ç•¥ï¼‰æˆ–æ— é™æ‰©å®¹ã€‚
* æ”¯æŒæŒ‡æ•°æ‰©å®¹ä¸çº¿æ€§æ‰©å®¹ç›¸ç»“åˆï¼Œé¿å…å†…å­˜æµªè´¹ã€‚


* **å¤šçº§åˆ«æ—¥å¿—**ï¼šæ”¯æŒ DEBUG, INFO, WARN, ERROR, FATAL äº”ä¸ªçº§åˆ«ã€‚
* **ä¸°å¯Œçš„åŠŸèƒ½**ï¼š
* æ”¯æŒç±»ä¼¼ `printf` æ ¼å¼çš„å¯å˜å‚æ•°æ—¥å¿—è¾“å‡ºã€‚
* æ”¯æŒ JSON é…ç½®æ–‡ä»¶åŠ è½½ã€‚
* ERROR/FATAL çº§åˆ«æ—¥å¿—æ”¯æŒå¼‚æ­¥å‘é€è‡³å¤‡ä»½æœåŠ¡å™¨ï¼ˆBackup Serverï¼‰ *"æ³¨æ„ï¼šè¿™é¡¹åŠŸèƒ½ç›®å‰åªæ·»åŠ äº†æ¥å£ï¼Œå¹¶æœªè®¾è®¡å…·ä½“çš„å®ç°"*ã€‚


* **ç°ä»£åŒ– C++ è®¾è®¡**ï¼šå¹¿æ³›ä½¿ç”¨ç°ä»£c++ç‰¹æ€§ï¼ˆå¦‚ Concepts, Filesystem, lambda, atomic ç­‰ï¼‰ä»¥åŠ RAII æœºåˆ¶ç®¡ç†èµ„æºã€‚

---

## ğŸ— ç³»ç»Ÿæ¶æ„

æ—¥å¿—ç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¨¡å—ç»„æˆï¼š

1. **Frontend (å‰ç«¯)**:
* **AsyncLogger**: é¢å‘ç”¨æˆ·çš„æ¥å£ï¼Œè´Ÿè´£å°†æ—¥å¿—æ ¼å¼åŒ–å¹¶å†™å…¥ç¼“å†²åŒºã€‚
* **Buffer**: å°è£…åçš„å†…å­˜ç¼“å†²åŒºï¼Œè´Ÿè´£æ•°æ®çš„å­˜å–å’Œæ‰©å®¹ã€‚


2. **Backend (åç«¯)**:
* **AsyncWorker**: åå°å·¥ä½œçº¿ç¨‹ï¼Œè´Ÿè´£å°†ç¼“å†²åŒºçš„æ•°æ®â€œæ¶ˆè´¹â€å¹¶åˆ†å‘ç»™å…·ä½“çš„ Flush å¯¹è±¡ã€‚å®ƒç®¡ç†ç€ç”Ÿäº§ç¼“å†²åŒºå’Œæ¶ˆè´¹ç¼“å†²åŒºçš„äº¤æ¢ï¼ˆSwapï¼‰ã€‚


3. **Sinks (è½åœ°)**:
* **LogFlush**: æŠ½è±¡åŸºç±»ï¼Œåˆ©ç”¨å·¥å‚æ¨¡å¼ (`LogFlushFactory`) åˆ›å»ºä¸åŒçš„è¾“å‡ºç›®æ ‡ï¼ˆæ§åˆ¶å°ã€æ–‡ä»¶ã€æ»šåŠ¨æ–‡ä»¶ï¼‰ã€‚


4. **Utilities**:
* **ThreadPool**: ç”¨äºå¤„ç†è€—æ—¶çš„éæ ¸å¿ƒä»»åŠ¡ï¼ˆå¦‚å‘é€æŠ¥è­¦æ—¥å¿—åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼‰ã€‚
* **Config**: åŸºäº JsonCpp çš„é…ç½®ç®¡ç†ã€‚



### æµç¨‹å›¾è§£

```text
[ä¸šåŠ¡çº¿ç¨‹] -> [AsyncLogger] -> [ç”Ÿäº§ç¼“å†²åŒº Buffer A]
                                     |
                                   (Swap)
                                     |
                                     v
[åå°çº¿ç¨‹] -> [AsyncWorker] -> [æ¶ˆè´¹ç¼“å†²åŒº Buffer B] -> [LogFlush] -> [ç£ç›˜/æ§åˆ¶å°]

```

---

## ğŸ“¦ ç¯å¢ƒä¾èµ–

* **æ“ä½œç³»ç»Ÿ**: Linux (å»ºè®® Ubuntu 20.04+)
* **ç¼–è¯‘å™¨**: GCC 10+ æˆ– Clang 10+ (éœ€æ”¯æŒ **C++20**)
* **æ„å»ºå·¥å…·**: CMake 3.10+
* **ç¬¬ä¸‰æ–¹åº“**:
* [JsonCpp](https://github.com/open-source-parsers/jsoncpp) (ç”¨äºè§£æé…ç½®æ–‡ä»¶)
* [GTest](https://github.com/google/googletest) (ç”¨äºå•å…ƒæµ‹è¯•)
* *(ä»…äº‘å­˜å‚¨æ¨¡å—éœ€è¦)*: `libevent`, `sqlite3`, `libzstd`



---

## ğŸ”¨ æ„å»ºä¸å®‰è£…

1. **å…‹éš†ä»“åº“**
```bash
git clone https://github.com/your_username/AsynLogSystemAndCloudStorage.git
cd AsynLogSystemAndCloudStorage

```


2. **åˆ›å»ºæ„å»ºç›®å½•**
```bash
mkdir build && cd build

```


3. **ç¼–è¯‘é¡¹ç›®**
```bash
cmake ..
make -j4

```


4. **è¿è¡Œæµ‹è¯•** (å¯é€‰)
```bash
./log_system/test/Test  # è¿è¡Œæ—¥å¿—ç³»ç»Ÿå•å…ƒæµ‹è¯•

```



---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ

åœ¨ä½ çš„ä¸»ç¨‹åºå…¥å£ï¼ˆå¦‚ `main` å‡½æ•°ï¼‰åˆå§‹åŒ–æ—¥å¿—é…ç½®ï¼š

```cpp
#include "log_system/src/Manager.hpp"
#include "log_system/src/MyLog.hpp"

// ä½¿ç”¨é»˜è®¤é…ç½®æˆ–åŠ è½½é…ç½®æ–‡ä»¶
// è¿™é‡Œé€šå¸¸åœ¨ mystorage::initServerLog() ä¸­å°è£…å¥½äº†
asynclog::Manager::getInstance(); 

```

### 2. è·å– Logger å¹¶è®°å½•æ—¥å¿—

ç³»ç»Ÿæä¾›äº†ä¾¿æ·çš„å®å®šä¹‰ï¼Œæ”¯æŒé»˜è®¤ Logger å’ŒæŒ‡å®š Loggerï¼š

```cpp
// è·å–æ—¥å¿—å™¨
auto logger = asynclog::Manager::getInstance().getLogger("cloud_storage_server");

// ä½¿ç”¨å®è¿›è¡Œæ—¥å¿—è®°å½• (æ–‡ä»¶åã€è¡Œå·ä¼šè‡ªåŠ¨æ·»åŠ )
LogDebug(logger, "This is a debug message: %d", 100);
LogInfo(logger, "Server started at port %d", 8080);
LogWarn(logger, "Disk space is low: %s", "80%");
LogError(logger, "Connection failed!");

// ä½¿ç”¨é»˜è®¤æ—¥å¿—å™¨çš„å®
LogDefaultInfo("This uses the default logger");

```

### 3. è‡ªå®šä¹‰æ„å»º Logger

å¦‚æœä½ éœ€è¦æ‰‹åŠ¨æ„å»ºä¸€ä¸ªç‰¹å®šçš„ Loggerï¼š

```cpp
asynclog::AsyncLoggerBuilder builder;
builder.setLoggerName("custom_logger");
builder.addLogFlush<asynclog::StdOutFlush>(); // æ·»åŠ æ§åˆ¶å°è¾“å‡º
builder.addLogFlush<asynclog::FileFlush>("test.log", config_data); // æ·»åŠ æ–‡ä»¶è¾“å‡º

auto my_logger = builder.build(thread_pool_ptr);
asynclog::Manager::getInstance().addLogger(my_logger);

```

---

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

é¡¹ç›®æ ¹ç›®å½•ä¸‹é€šå¸¸åŒ…å« `log_config.conf`ï¼Œé‡‡ç”¨ JSON æ ¼å¼ï¼š

```json
{
    "buffer_size": 10485760,      // ç¼“å†²åŒºåˆå§‹å¤§å° (10MB)
    "threshold": 10737418240,     // ç¼“å†²åŒºæ‰©å®¹é˜ˆå€¼ï¼Œè¶…è¿‡ååˆ‡æ¢å¢é•¿ç­–ç•¥
    "linear_growth": 10485760,    // çº¿æ€§å¢é•¿æ­¥é•¿
    "flush_log": 2,               // åˆ·ç›˜ç­–ç•¥: 0=æ— , 1=fflush, 2=fsync (æ›´å®‰å…¨ä½†ç¨æ…¢)
    "backup_addr": "47.116.XX.XX",// è¿œç¨‹å¤‡ä»½æœåŠ¡å™¨ IP (ç”¨äº ERROR/FATAL)
    "backup_port": 8080,          // è¿œç¨‹å¤‡ä»½æœåŠ¡å™¨ç«¯å£
    "thread_count": 3             // è¾…åŠ©çº¿ç¨‹æ± çº¿ç¨‹æ•°
}

```

---

## â˜ï¸ äº‘å­˜å‚¨æ¨¡å—ç®€ä»‹

è™½ç„¶æœ¬æ–‡æ¡£ä¾§é‡äºæ—¥å¿—ç³»ç»Ÿï¼Œä½†æœ¬é¡¹ç›®åŒ…å«ä¸€ä¸ªå®Œæ•´çš„äº‘å­˜å‚¨æœåŠ¡å™¨å®ç° (`src/server/`)ã€‚

* **åŸºäº Libevent**: ä½¿ç”¨ Reactor æ¨¡å‹å¤„ç†é«˜å¹¶å‘ HTTP è¯·æ±‚ã€‚
* **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒ HTTP Range è¯·æ±‚ï¼Œå®ç°å¤§æ–‡ä»¶æ–­ç‚¹ä¸‹è½½ã€‚
* **æ•°æ®ç®¡ç†**: ä½¿ç”¨ SQLite3 å­˜å‚¨æ–‡ä»¶å…ƒæ•°æ®ï¼ˆçƒ­åº¦ã€è·¯å¾„ã€Hashï¼‰ã€‚
* **æ–‡ä»¶å‹ç¼©**: é›†æˆ Zstd å‹ç¼©ç®—æ³•ï¼Œå¯¹â€œæ·±åº¦å­˜å‚¨â€æ–‡ä»¶è¿›è¡Œè‡ªåŠ¨å‹ç¼©ä»¥èŠ‚çœç©ºé—´ã€‚
* **çƒ­ç‚¹ç®¡ç†**: åŒºåˆ† Low (æµ…åº¦/çƒ­æ•°æ®) å’Œ Deep (æ·±åº¦/å†·æ•°æ®) å­˜å‚¨åŒºåŸŸã€‚

---
